═══════════════════════════════════════════════════════════════════════════════════
                    HDBSCAN CLUSTERING PIPELINE FLOW ILLUSTRATION
═══════════════════════════════════════════════════════════════════════════════════

## 🏗️ OVERALL ARCHITECTURE OVERVIEW

┌─────────────────────────────────────────────────────────────────────────────────┐
│                           HYBRID AZURE ARCHITECTURE                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐         │
│  │  AZURE FUNCTIONS │    │  AZURE FUNCTIONS │    │   AZURE VM       │         │
│  │   (Consumption)  │    │    (Premium)     │    │   (Training)     │         │
│  │                  │    │                  │    │                  │         │
│  │   PREPROCESSING  │    │   PREDICTION     │    │    TRAINING      │         │
│  │   Every 1 Hour   │    │   Every 2 Hours  │    │   Quarterly      │         │
│  │                  │    │                  │    │   (Manual)       │         │
│  └──────────────────┘    └──────────────────┘    └──────────────────┘         │
│           │                        │                        │                  │
│           ▼                        ▼                        ▼                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                       SHARED STORAGE LAYER                             │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │   │
│  │  │   BigQuery   │  │ Blob Storage │  │ App Insights │  │ Key Vault   │ │   │
│  │  │   Tables     │  │   Models     │  │  Monitoring  │  │  Secrets    │ │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘

## 📊 DATA FLOW THROUGH PIPELINE

### STAGE 1: PREPROCESSING PIPELINE (HOURLY)
┌─────────────────────────────────────────────────────────────────────────────────┐
│                               PREPROCESSING FLOW                               │
└─────────────────────────────────────────────────────────────────────────────────┘

Timer Trigger (Every Hour)
        │
        ▼
┌───────────────────┐     ┌─────────────────┐     ┌──────────────────┐
│   Check Watermark│────▶│  Query BigQuery │────▶│   New Incidents  │
│   Last Processed │     │   for New Data  │     │   Since Watermark│
│   Timestamp       │     │                 │     │                  │
└───────────────────┘     └─────────────────┘     └──────────────────┘
                                                           │
                                                           ▼
┌───────────────────┐     ┌─────────────────┐     ┌──────────────────┐
│  Update Watermark│◀────│   Store Results │◀────│  Generate Summary│
│   Timestamp       │     │   to BigQuery   │     │   & Embeddings   │
│                   │     │                 │     │                  │
└───────────────────┘     └─────────────────┘     └──────────────────┘

Tech Center Loop (15 Centers):
┌─────────────────────────────────────────────────────────────────────────────────┐
│ FOR EACH TECH CENTER:                                                          │
│                                                                                 │
│ 1. Get watermark: SELECT last_processed FROM watermarks                        │
│    WHERE tech_center = 'BT-TC-Product Development & Engineering'               │
│                                                                                 │
│ 2. Query new incidents:                                                        │
│    WHERE sys_created_on > watermark AND tech_center = 'BT-TC-...'             │
│                                                                                 │
│ 3. Text processing:                                                            │
│    short_description + description → combined_incidents_summary                │
│                                                                                 │
│ 4. Generate embeddings:                                                        │
│    combined_incidents_summary → semantic embedding (1536 dimensions)          │
│    Weights: entity=0.0, action=0.0, semantic=1.0                             │
│                                                                                 │
│ 5. Store in preprocessing table:                                               │
│    INSERT INTO preprocessing_pipeline.preprocessed_incidents                   │
│                                                                                 │
│ 6. Update watermark:                                                           │
│    UPDATE watermarks SET last_processed = CURRENT_TIMESTAMP()                 │
└─────────────────────────────────────────────────────────────────────────────────┘

### STAGE 2: PREDICTION PIPELINE (EVERY 2 HOURS)
┌─────────────────────────────────────────────────────────────────────────────────┐
│                               PREDICTION FLOW                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

Timer Trigger (Every 2 Hours)
        │
        ▼
┌───────────────────┐     ┌─────────────────┐     ┌──────────────────┐
│  Load Trained     │────▶│   Get New       │────▶│   Run HDBSCAN    │
│  Models from      │     │ Preprocessed    │     │   Predictions    │
│  Blob Storage     │     │     Data        │     │                  │
└───────────────────┘     └─────────────────┘     └──────────────────┘
                                                           │
                                                           ▼
┌───────────────────┐     ┌─────────────────┐     ┌──────────────────┐
│   Store Results   │◀────│  Apply Labels   │◀────│  Generate Cluster│
│   to BigQuery     │     │   & Domains     │     │    Assignments   │
│                   │     │                 │     │                  │
└───────────────────┘     └─────────────────┘     └──────────────────┘

Tech Center Prediction Loop:
┌─────────────────────────────────────────────────────────────────────────────────┐
│ FOR EACH TECH CENTER:                                                          │
│                                                                                 │
│ 1. Load current quarter model:                                                 │
│    - hdbscan_clusterer.pkl                                                     │
│    - umap_reducer.pkl                                                          │
│    - labeled_clusters.json                                                     │
│    - domains.json                                                              │
│                                                                                 │
│ 2. Get new preprocessed data:                                                  │
│    WHERE processed_at > last_prediction_time                                   │
│    AND tech_center = 'BT-TC-...'                                              │
│                                                                                 │
│ 3. Run predictions:                                                            │
│    embedding → UMAP transform → HDBSCAN predict                               │
│                                                                                 │
│ 4. Apply labels:                                                               │
│    cluster_id → cluster_topic, domain_name, confidence_score                  │
│                                                                                 │
│ 5. Store predictions:                                                          │
│    INSERT INTO clustering_predictions                                          │
│    (number, predicted_cluster, cluster_topic, domain, confidence_score)       │
└─────────────────────────────────────────────────────────────────────────────────┘

### STAGE 3: TRAINING PIPELINE (QUARTERLY - MANUAL)
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                TRAINING FLOW                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

Manual Trigger (Data Scientist)
        │
        ▼
┌───────────────────┐     ┌─────────────────┐     ┌──────────────────┐
│  python main_     │────▶│  Get Quarter    │────▶│   Load Training  │
│  enhanced.py train│     │     Data        │     │      Data        │
│  --quarter q4     │     │                 │     │                  │
└───────────────────┘     └─────────────────┘     └──────────────────┘
                                                           │
                                                           ▼
┌───────────────────┐     ┌─────────────────┐     ┌──────────────────┐
│  Save Models to   │◀────│  Parallel Train │◀────│   UMAP + HDBSCAN │
│   Blob Storage    │     │  15 Tech Centers│     │     Training     │
│                   │     │                 │     │                  │
└───────────────────┘     └─────────────────┘     └──────────────────┘

Parallel Training Process:
┌─────────────────────────────────────────────────────────────────────────────────┐
│ PARALLEL TRAINING (ThreadPoolExecutor, max_workers=4):                         │
│                                                                                 │
│ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│ │ Tech Center │  │ Tech Center │  │ Tech Center │  │ Tech Center │           │
│ │     1       │  │     2       │  │     3       │  │     4       │           │
│ │             │  │             │  │             │  │             │           │
│ │ 1. Load Q4  │  │ 1. Load Q4  │  │ 1. Load Q4  │  │ 1. Load Q4  │           │
│ │    Data     │  │    Data     │  │    Data     │  │    Data     │           │
│ │ 2. UMAP     │  │ 2. UMAP     │  │ 2. UMAP     │  │ 2. UMAP     │           │
│ │    Fit      │  │    Fit      │  │    Fit      │  │    Fit      │           │
│ │ 3. HDBSCAN  │  │ 3. HDBSCAN  │  │ 3. HDBSCAN  │  │ 3. HDBSCAN  │           │
│ │    Fit      │  │    Fit      │  │    Fit      │  │    Fit      │           │
│ │ 4. LLM      │  │ 4. LLM      │  │ 4. LLM      │  │ 4. LLM      │           │
│ │    Labels   │  │    Labels   │  │    Labels   │  │    Labels   │           │
│ │ 5. Save     │  │ 5. Save     │  │ 5. Save     │  │ 5. Save     │           │
│ │    Models   │  │    Models   │  │    Models   │  │    Models   │           │
│ └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘           │
│       ▼                ▼                ▼                ▼                     │
│ ┌─────────────────────────────────────────────────────────────────────────┐   │
│ │             BLOB STORAGE: prediction-artifacts/                        │   │
│ │  BT_TC_Product_Development_Engineering/2024/q4/                        │   │
│ │  ├── clustering/                                                       │   │
│ │  │   ├── hdbscan_clusterer.pkl                                         │   │
│ │  │   └── umap_reducer.pkl                                              │   │
│ │  ├── analysis/                                                         │   │
│ │  │   ├── labeled_clusters.json                                         │   │
│ │  │   └── domains.json                                                  │   │
│ │  └── metadata/                                                         │   │
│ │      └── training_metadata.json                                        │   │
│ └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘

## 🔄 COMPLETE QUARTERLY CYCLE

┌─────────────────────────────────────────────────────────────────────────────────┐
│                          QUARTERLY OPERATIONAL CYCLE                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  JANUARY - MARCH (Q1)                                                         │
│  ────────────────────                                                         │
│  📅 Daily: Preprocessing (hourly) + Prediction (2-hourly)                     │
│  📊 Using: Q4 2023 models                                                     │
│  💾 Data: Accumulating in preprocessing_pipeline.preprocessed_incidents       │
│                                                                                 │
│  END OF MARCH: Q1 TRAINING                                                    │
│  ─────────────────────────                                                    │
│  🔧 Manual: python main_enhanced.py train --year 2024 --quarter q1            │
│  ⏱️  Duration: 2-4 hours                                                       │
│  📦 Output: New Q1 2024 models stored in Blob Storage                         │
│  🔄 Switch: Functions automatically use Q1 2024 models                        │
│                                                                                 │
│  APRIL - JUNE (Q2)                                                            │
│  ──────────────────                                                           │
│  📅 Daily: Preprocessing + Prediction continues                               │
│  📊 Using: Q1 2024 models                                                     │
│  💾 Data: More incidents accumulating                                         │
│                                                                                 │
│  ... cycle continues for Q2, Q3, Q4 ...                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

## 💾 DATA STORAGE STRUCTURE

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              BIGQUERY TABLES                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  📊 RAW DATA:                                                                  │
│  enterprise-dashboardnp-cd35.bigquery_datasets_spoke_oa_dev.incidents_table   │
│  ├── number (STRING)                                                           │
│  ├── short_description (STRING)                                                │
│  ├── description (STRING)                                                      │
│  ├── sys_created_on (TIMESTAMP)                                                │
│  ├── tech_center (STRING)                                                      │
│  └── ... other incident fields                                                 │
│                                                                                 │
│  🔄 PREPROCESSED DATA:                                                         │
│  enterprise-dashboardnp-cd35.preprocessing_pipeline.preprocessed_incidents    │
│  ├── number (STRING)                                                           │
│  ├── sys_created_on (TIMESTAMP)                                                │
│  ├── combined_incidents_summary (STRING)                                       │
│  ├── embedding (ARRAY<FLOAT64>)                                                │
│  ├── tech_center (STRING)                                                      │
│  └── processed_at (TIMESTAMP)                                                  │
│                                                                                 │
│  🎯 PREDICTIONS:                                                               │
│  enterprise-dashboardnp-cd35.bigquery_datasets_hone_srv_dev.clustering_       │
│  predictions                                                                   │
│  ├── number (STRING)                                                           │
│  ├── predicted_cluster (INTEGER)                                               │
│  ├── cluster_topic (STRING)                                                    │
│  ├── domain_name (STRING)                                                      │
│  ├── confidence_score (FLOAT64)                                                │
│  ├── tech_center (STRING)                                                      │
│  └── predicted_at (TIMESTAMP)                                                  │
│                                                                                 │
│  📝 WATERMARKS:                                                                │
│  enterprise-dashboardnp-cd35.preprocessing_pipeline.preprocessing_watermarks  │
│  ├── tech_center (STRING)                                                      │
│  ├── last_processed_timestamp (TIMESTAMP)                                      │
│  └── updated_at (TIMESTAMP)                                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              BLOB STORAGE STRUCTURE                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  prediction-artifacts/                                                         │
│  ├── models/                                                                   │
│  │   ├── BT_TC_Product_Development_Engineering/                               │
│  │   │   ├── 2024/                                                            │
│  │   │   │   ├── q1/                                                          │
│  │   │   │   │   ├── clustering/                                              │
│  │   │   │   │   │   ├── hdbscan_clusterer.pkl                                │
│  │   │   │   │   │   └── umap_reducer.pkl                                     │
│  │   │   │   │   ├── analysis/                                                │
│  │   │   │   │   │   ├── labeled_clusters.json                                │
│  │   │   │   │   │   └── domains.json                                         │
│  │   │   │   │   └── metadata/                                                │
│  │   │   │   │       └── training_metadata.json                               │
│  │   │   │   ├── q2/ (similar structure)                                      │
│  │   │   │   ├── q3/ (similar structure)                                      │
│  │   │   │   └── q4/ (similar structure)                                      │
│  │   │   └── current -> 2024/q4  (symlink to current quarter)                 │
│  │   ├── BT_TC_Infrastructure_Services/ (similar structure)                   │
│  │   ├── BT_TC_Network_Operations/ (similar structure)                        │
│  │   └── ... (13 more tech centers)                                           │
│  ├── predictions/                                                              │
│  │   └── batch_predictions/ (archived prediction results)                     │
│  └── monitoring/                                                               │
│      ├── drift_detection/                                                      │
│      └── performance_tracking/                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

## ⏰ TIMELINE EXAMPLE: ONE WEEK OPERATIONS

┌─────────────────────────────────────────────────────────────────────────────────┐
│                           WEEKLY OPERATIONS TIMELINE                           │
└─────────────────────────────────────────────────────────────────────────────────┘

MONDAY, 10:00 AM
├── [Function] Preprocessing: 127 new incidents across 15 tech centers
├── [Function] Prediction: 98 incidents classified using Q3 2024 models
└── [Storage] Data stored in BigQuery + monitoring logs

MONDAY, 11:00 AM  
├── [Function] Preprocessing: 89 new incidents processed
└── [Function] (No prediction - runs every 2 hours)

MONDAY, 12:00 PM
├── [Function] Preprocessing: 156 new incidents processed  
├── [Function] Prediction: 245 incidents classified (from 11:00 + 12:00)
└── [Storage] Updated prediction results in BigQuery

... continues every hour/2 hours ...

TUESDAY through SUNDAY
├── Same automated pattern continues 24/7
├── Total week: ~15,000 incidents processed
├── Total week: ~12,000 predictions made
└── Zero human intervention required

END OF QUARTER (Manual Intervention)
├── Data Scientist connects to Azure VM
├── Executes: python main_enhanced.py train --year 2024 --quarter q4
├── Monitors parallel training: 4 hours total
├── New Q4 models saved to Blob Storage
├── Functions automatically switch to Q4 models
└── Cycle continues with updated models

## 🔄 ERROR HANDLING & RECOVERY

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ERROR HANDLING FLOW                               │
└─────────────────────────────────────────────────────────────────────────────────┘

Preprocessing Function Error:
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   API Timeout   │───▶│   Retry Logic   │───▶│  Partial Save   │
│   Rate Limit    │    │   (3 attempts)  │    │   Continue Next │
│   Network Error │    │                 │    │   Tech Center   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
        │                        │                        │
        ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Log Error     │    │   Alert Admin   │    │   Update Status │
│   Application   │    │   via Email     │    │   for Monitoring│
│   Insights      │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘

Prediction Function Error:
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Model Missing  │───▶│ Load Previous   │───▶│  Continue with  │
│  Blob Storage   │    │ Quarter Model   │    │  Fallback Model │
│  Connection     │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘

Training Pipeline Error:
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Tech Center 5   │───▶│   Skip Failed   │───▶│   Continue      │
│ Training Failed │    │   Continue with │    │   Training 6-15 │
│                 │    │   Others        │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘

## 📊 MONITORING & METRICS

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              MONITORING DASHBOARD                              │
└─────────────────────────────────────────────────────────────────────────────────┘

Real-time Metrics:
┌─────────────────────────────────────────────────────────────────────────────────┐
│ PREPROCESSING PIPELINE                                                          │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│ │  Incidents  │ │ Execution   │ │  Success    │ │   Error     │               │
│ │ Per Hour    │ │   Time      │ │    Rate     │ │    Rate     │               │
│ │     127     │ │   8.5 min   │ │    99.2%    │ │    0.8%     │               │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │
│                                                                                 │
│ PREDICTION PIPELINE                                                             │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│ │ Predictions │ │ Execution   │ │ Confidence  │ │  Model      │               │
│ │  Per 2Hr    │ │   Time      │ │   Score     │ │ Version     │               │
│ │     245     │ │  12.3 min   │ │    0.87     │ │  2024-Q3    │               │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │
│                                                                                 │
│ TRAINING PIPELINE                                                               │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│ │ Last Train  │ │   Status    │ │ Tech Centers│ │  Next Due   │               │
│ │    Date     │ │             │ │ Successful  │ │    Date     │               │
│ │ 2024-09-30  │ │  Complete   │ │   15/15     │ │ 2024-12-31  │               │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │
└─────────────────────────────────────────────────────────────────────────────────┘

Cost Tracking:
┌─────────────────────────────────────────────────────────────────────────────────┐
│ MONTHLY COSTS (USD)                                                            │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐                   │
│ │ Preprocessing   │ │   Prediction    │ │    Training     │                   │
│ │   Functions     │ │   Functions     │ │      VM         │                   │
│ │      $45        │ │     $165        │ │      $35        │                   │
│ │ (Consumption)   │ │   (Premium)     │ │ (16 hrs/quarter)│                   │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘                   │
│                                                                                 │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐                   │
│ │  Blob Storage   │ │    BigQuery     │ │     Total       │                   │
│ │  (Models/Logs)  │ │  (Data/Queries) │ │   Monthly       │                   │
│ │      $25        │ │      $75        │ │     $345        │                   │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘                   │
└─────────────────────────────────────────────────────────────────────────────────┘

## 🎯 SUMMARY: END-TO-END FLOW

1. ⏰ **HOURLY**: New incidents detected → text summarized → embeddings generated
2. ⏰ **2-HOURLY**: Embeddings classified → clusters assigned → results stored  
3. ⏰ **QUARTERLY**: All data retrained → new models created → automatic deployment
4. 📊 **CONTINUOUS**: Monitoring metrics → error handling → cost optimization
5. 👥 **TEAM**: Automated operations + quarterly manual training supervision

═══════════════════════════════════════════════════════════════════════════════════
                              END OF FLOW ILLUSTRATION
═══════════════════════════════════════════════════════════════════════════════════